<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dressca.cms.announcement.infrastructure.repository.mybatis.mapper.AnnouncementCustomMapper">
  
  <resultMap id="AnnouncementWithContentsResultMap" type="com.dressca.cms.announcement.applicationcore.dto.Announcement">
    <id column="id" jdbcType="OTHER" property="id" typeHandler="com.dressca.cms.announcement.infrastructure.repository.mybatis.handler.UuidTypeHandler" />
    <result column="category" jdbcType="VARCHAR" property="category" />
    <result column="post_date_time" jdbcType="TIMESTAMP_WITH_TIMEZONE" property="postDateTime" />
    <result column="expire_date_time" jdbcType="TIMESTAMP_WITH_TIMEZONE" property="expireDateTime" />
    <result column="display_priority" jdbcType="INTEGER" property="displayPriority" />
    <result column="created_at" jdbcType="TIMESTAMP_WITH_TIMEZONE" property="createdAt" />
    <result column="changed_at" jdbcType="TIMESTAMP_WITH_TIMEZONE" property="changedAt" />
    <result column="is_deleted" jdbcType="BOOLEAN" property="isDeleted" />
    <collection property="contents" ofType="com.dressca.cms.announcement.applicationcore.dto.AnnouncementContent">
      <id column="content_id" jdbcType="OTHER" property="id" typeHandler="com.dressca.cms.announcement.infrastructure.repository.mybatis.handler.UuidTypeHandler" />
      <result column="id" jdbcType="OTHER" property="announcementId" typeHandler="com.dressca.cms.announcement.infrastructure.repository.mybatis.handler.UuidTypeHandler" />
      <result column="language_code" jdbcType="VARCHAR" property="languageCode" />
      <result column="title" jdbcType="VARCHAR" property="title" />
      <result column="message" jdbcType="VARCHAR" property="message" />
      <result column="link_url" jdbcType="VARCHAR" property="linkUrl" />
    </collection>
  </resultMap>
  
  <select id="findAnnouncementsWithContentsByOffsetAndLimit" resultMap="AnnouncementWithContentsResultMap">
    SELECT 
      a.id,
      a.category,
      a.post_date_time,
      a.expire_date_time,
      a.display_priority,
      a.created_at,
      a.changed_at,
      a.is_deleted,
      ac.id as content_id,
      ac.language_code,
      ac.title,
      ac.message,
      ac.link_url
    FROM announcement a
    LEFT JOIN announcement_content ac ON a.id = ac.announcement_id
    WHERE a.is_deleted = false
    ORDER BY a.post_date_time DESC, a.id, ac.language_code
    LIMIT #{limit} OFFSET #{offset}
  </select>
  
</mapper>
