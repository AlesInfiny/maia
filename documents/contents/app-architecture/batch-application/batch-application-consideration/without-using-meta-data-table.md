---
title: バッチアプリケーション編
description: バッチアプリケーションでの検討事項としてメタデータテーブルの必要性について解説します。
---

# メタデータテーブルの必要性について {#top}

本サンプルアプリケーションは、 Spring Batch のアーキテクチャを利用してバッチ処理を実現しています。
Spring Batch では、バッチの実行履歴や実行状態の保存といったジョブ管理のためにメタデータテーブルを既定しており、バッチアプリケーションを実行するためにはそれらを作成しておく必要があります。
作成されるメタデータテーブルについては、[メタデータテーブルを作成するスキーマ :material-open-in-new:](https://spring.pleiades.io/spring-batch/reference/schema-appendix.html){ target=_blank } をご覧ください。

クラウドサービスのリソースにバッチアプリケーションを配置する場合や、バッチアプリケーションのジョブ管理を他のジョブ管理ツールに任せる場合、 Spring Batch でジョブを管理するためのメタデータテーブルは必要ありません。

しかしながら、 Spring Batch 上のジョブ管理機能が不要な場合でも Spring Batch の仕様によってメタデータテーブルがなければエラーが発生し、メタデータテーブルの作成が強要されます。
そのため、 Spring Batch を利用する上で作成が必須となるメタデータテーブルに対し、とりうる対応について説明します。

## メタデータテーブルをインメモリデータベースに作成するよう設定する {#definition-meta-data-table-by-in-memory-db}

前述の通り、 Spring Batch を利用するうえで不要なメタデータテーブルの作成が必須です。
このメタデータテーブルを実テーブルとして作成すると、不要な機能のためのテーブル管理が要求されます。

Spring Batch では、メインのデータベースとは別にメタデータテーブル管理用のセカンダリデータベースを設定できます。
メタデータテーブル用のセカンダリデータベースに `H2` のようなインメモリデータベースを指定することで実行時にだけ生成されるテーブルとなり、アプリケーションの終了と共にメタデータテーブルが削除されるようになります。

メタデータテーブル用のセカンダリデータベースを設定するためには、 [@BatchDataSource アノテーション :material-open-in-new:](https://spring.pleiades.io/spring-boot/api/java/org/springframework/boot/autoconfigure/batch/BatchDataSource.html){ target=_blank } を利用できます。

!!! warning "バッチアプリケーションを常時稼働させる際の注意点"

    [@Scheduled アノテーション :material-open-in-new:](https://spring.pleiades.io/guides/gs/scheduling-tasks){ target=_blank } を利用するなどでアプリケーションを常時稼働させ続ける場合、バッチ処理の終了でアプリケーションが終了しません。
    これにより、メタデータテーブルの削除が行われずインメモリデータべース内にデータが蓄積され続けることでメモリが消費され、 Out Of Memory Error が発生する可能性があります。
    このような場合、以下に示すような対応が必要になります。

    - ジョブ管理ツール上で適時バッチを定期的に実行するようスケジューリングすることで、バッチ処理の完了と共にアプリケーションが必ず終了するようにする
    - バッチ処理の終了と共にメタデータテーブルの削除処理を行うよう変更する
    - メタデータがメインのデータベースに蓄積されることを許容し、ジョブ管理ツール上でデータ削除用のジョブを設定する（後述）

## ジョブ管理ツール上で定期的にメタデータを削除するよう設定する {#delete-meta-data-table-on-tools}

メインのデータベースにメタデータテーブルが作成されることを許容し、定期的にデータを削除するよう設定する方法です。
日次や週次といったタイミングで、自動的にメタデータテーブル内のデータが削除されるよう設定するとよいでしょう。
