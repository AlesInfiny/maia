# Java アプリケーションの処理方式

アプリケーションの形態によらず、 Java アプリケーションで考慮すべき各種関心事について、その実装方針を説明します。

## 例外処理方針 {: #exception-policy }

アプリケーション全体での例外処理方針を定めます。

### 例外の種類 {: #exception-pattern }

Maia OSS 版では、アプリケーションで発生する例外を[業務例外](#business-exception)と[システム例外](#system-exception)の 2 つに分類します。
それぞれの例外の意味や処理方針を以下に示します。

#### 業務例外 {: #business-exception }

- 意味

    業務フロー上、想定されるエラーを表す例外です。

- 発生箇所

    アプリケーションコア層の業務ロジック内で、明示的にスローします。

- 処理方針

    プレゼンテーション層でキャッチし、業務フローに応じた処理を行います。

#### システム例外 {: #system-exception }

- 意味

    業務フロー上は想定されないシステムのエラーを表す例外です。
    実行ランタイムまでキャッチされずに到達した例外は、すべてシステム例外として取り扱います。

- 発生箇所

    Java の実行ランタイム内からスローされます。
    またアプリケーションとして想定していない状態となったとき、業務ロジック内から明示的にスローすることがあります。

- 処理方針

    集約例外ハンドラ内でキャッチして、システムエラーの処理フローを実行します。

### 業務例外とシステム例外の使い分け {: #usage-of-business-and-system-exceptions }

原則として、システム例外は業務ロジック内からスローしないようにします。
何らかのエラー状態を業務ロジックとして検出するのであれば、そのエラーを回復するための手段を業務フローとして設計し、業務例外として処理します。

ただし利用するライブラリによっては、本来システムエラーとして取り扱うべきエラーを、検査例外としてスローするケースがあります。
このようなケースでは、すべての検査例外に対応する業務ロジックを設計したり、ユーザーの再操作によってエラー状態を回復したりすることは困難です。
Maia OSS 版では、業務フロー内で検査例外が発生した際の処理として、システム例外に付け替えてリスローすることを許可します。

## ログ出力方針 {: #logging-policy }

概要編では、一般的なログの種類とログレベルを定めます。
アプリケーション形態ごとに個別に検討が必要なものについては別途定めます。
アプリケーション形態別のアプリケーションアーキテクチャ解説も、あわせて参照してください。

### ログの種類 {: #log-pattern }

Maia OSS 版で定義するログの種類は以下の通りです。

- 操作ログ

    ユーザーの操作履歴や、アプリケーションに対して行った操作を記録するログを操作ログと呼びます。

- 通信ログ

    アプリケーションがネットワークを介して通信を行う際、送受信する業務データや、送信先の情報、ヘッダー情報等を記録するログを通信ログと呼びます。

- 監査ログ

    アプリケーションの持つデータに対して行われた CRUD 処理を、誰がいつ実行したか記録するログを監査ログと呼びます。

- アプリケーションログ

    ここまでのログの種類に該当しない、アプリケーションのロジック内から出力する汎用的なログをアプリケーションログと呼びます。

### ログレベル {: #log-level }

出力するログにはログレベルを定義します。
ログレベルの定義は以下の通りです。

- Critical

    ？？あるの？？
    業務の即時停止につながる可能性のあるログを出力するときに使用するログレベルです。

- Error

    一部の業務が停止する可能性のあるログを出力するときに使用するログレベルです。
    マスターデータの不整合や、原因の不明なエラー発生など、システム運用担当者による確認や対処が必要となる状態を通知する目的に使用します。

- Warning

    業務は継続できるものの、一時的に発生したエラー状態を出力するときに使用するログレベルです。
    業務エラーの記録など、システム運用担当者による対応は不要なものの、システムとして不安定な状態を記録する際使用します。

- Information

    システム運用にあたって必要となる情報を出力するときに使用するログレベルです。
    バッチ処理の開始／終了の記録など、システムの状態を記録する際使用します。

- Debug

    開発者がアプリケーションの開発のために使用するログレベルです。
    各メソッドの入出力データなど、開発目的の情報を記録する際使用します。

### ログレベルと環境ごとの出力設定 {: #configuration-of-log-levels-and-output-per-environment }

システムの実行環境にあわせて、適切なレベルのログを出力するように構成します。

| ログレベル  |      本番環境      |     テスト環境     |  ローカル開発環境  |
| ----------- | :----------------: | :----------------: | :----------------: |
| Critical    | :white_check_mark: | :white_check_mark: | :white_check_mark: |
| Error       | :white_check_mark: | :white_check_mark: | :white_check_mark: |
| Warning     | :white_check_mark: | :white_check_mark: | :white_check_mark: |
| Information | :white_check_mark: | :white_check_mark: | :white_check_mark: |
| Debug       |                    |                    | :white_check_mark: |

### ログに含める標準データ {: #standard-log-data }

以下の情報をログに含めます。

- ログ出力日時
- ログレベル
- エラーコード？
- メッセージ
- スタックトレース ( 例外を記録するログのみ )

？？？Log4jで勝手に出せるものって他に何がある？？？

### ロギングライブラリ {: #logging-libraries }

Maia OSS 版では、 Java アプリケーションのロギングライブラリとして [Apache Log4j 2](https://logging.apache.org/log4j/2.x/) を使用します。
またロギングファサードとして [SLF4J](https://www.slf4j.org/) を使用します。

## メッセージ管理方針 {: #message-management-policy }

メッセージ文字列は、表記の統一を図る目的にプロパティファイルで管理します。

<!-- ### トランザクション管理 -->

## 入力値検査方針 {: #validation-policy }

入力値単体や、入力値同士の比較によって検証可能な入力値検証は、入出力インターフェースとなる場所で検証を行います。
入力値単体では検証できず、データストア内のデータとの比較によって検証する場合はアプリケーションコア層の業務ロジックで検証を行います。

<!-- ### セキュリティ対策 -->
