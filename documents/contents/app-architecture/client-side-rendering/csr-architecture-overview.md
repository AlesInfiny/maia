# CSRアーキテクチャ概要

Maia OSS 版において、クライアントサイドレンダリング方式のWebアプリケーションを構築する際に想定しているアーキテクチャの概要について説明します。

## 技術スタック

本アーキテクチャを構成する主なライブラリを以下に示します。

- 概要編で挙げた図をライブラリレベルまで詳細化した図。
- このレベル <https://terasolunaorg.github.io/guideline/5.7.0.RELEASE/ja/Overview/FrameworkStack.html#software-framework>
<!-- - クライアント側も含めて記載する。 -->

### 利用ライブラリ

- 技術スタックの図で記載したライブラリ一つ一つの説明。
- Spring系ライブラリ、という書き方ではなく、実際にサンプルAPに組み込むものを具体的に書く。
    - 基本的には簡易な機能説明でよいが、プロジェクト側で設定が必要なものなどはある程度具体的な使い方まで説明。（今回は書かないが、Spring Securityなど）

- Spring Boot
- Spring Core
- Spring MVC
- Spring Validation
- Spring Test
- MyBatis
- H2 Database
- Log4j
- Apache Commons Lang
- Springdoc-openapi

## アプリケーションアーキテクチャ

- 本アーキテクチャの全体概要図。以下のことが伝わるように
    - クリーンアーキテクチャを基本としていること
    - アプリケーションコア層/プレゼンテーション層/インフラストラクチャ層の各名称と依存関係
    - 各層に含まれる主要なコンポーネント（Controller、Domain Modelなど重要なものだけ。図が煩雑になりすぎる場合は、次節で解説しているので割愛も可）
    - システム共通機能は、ここには出てこなくてよい（役割としては単なる部品であり、アーキテクチャ図に含めると説明しにくい。）
- クリーンアーキテクチャ、レイヤードアーキテクチャ、ＤＤＤの知識は前提にしてよい（リンク先だけ提示）

## レイヤー構造詳細

- 各レイヤーとそれを構成するコンポーネントの役割を解説。
- 各種DTOなども含める。
- レイヤーをまたぐコンポーネントの依存関係も示す。とくにRepository関連は分かりやすいように図示。
- ここを参考に <http://terasolunaorg.github.io/guideline/current/ja/Overview/ApplicationLayering.html>

### プロジェクト構成とのマッピング

- Maia OSS 版が推奨する Java プロジェクトの構成（マルチプロジェクト構成）と各レイヤーのマッピング。
- 各レイヤーに相当するプロジェクトの内部構成についても簡単に示す。（ディレクトリ構造を示す程度でよい）
- システム共通機能についても軽く触れる。
    - どの層からも参照される共通機能を提供する。
    - アプリケーションコア層に実装してもよいが、特に中規模以上の開発などにおいてシステム共通化チームからの提供物を別ライブラリとして分けておいた方が保守性が高まると考えられるため、別プロジェクトにすることを推奨。
- 参考 <http://terasolunaorg.github.io/guideline/current/ja/Overview/ApplicationLayering.html#application-layering-project-structure>

## 全体機能方針

アプリケーション全体の関心事となる各種機能の実装方針を説明します。

### 例外処理

- v0.1では、サーバーサイドでの例外処理にのみ注目して記載する
- 例外分類と対応クラス、処理方針は以下の通り。
    - 業務例外
        - 意味：業務フロー上、想定されるエラーを表す例外
        - クラス：LogicException
        - 発生箇所：アプリケーションコア層の業務ロジック内
        - 処理方針：プレゼンテーション層のController内でキャッチして、業務フローに応じた処理を行う。Controllerでキャッチされなかった場合は、下記のシステム例外として集約例外ハンドラに処理される。
    - システム例外
        - 意味：業務フロー上は想定されないシステムのエラーを表す例外
        - クラス：SystemException
        - 発生箇所：任意のロジック
        - 処理方針：集約例外ハンドラであるControllerAdvice内でキャッチして、業務フローに応じた処理を行う。
- サーバーサイド全体での例外処理の方針を表す図。
- 集約例外ハンドラについての詳細は、[サーバーサイド機能詳細のプレゼンテーション層](server-side-function/presentation.md)を参照のこと。

### ログ出力

- v0.1では、サーバーサイドでの例外処理にのみ注目して記載する。
- ログ出力には、Log4jを利用する。出力先やフォーマットの設定は、Log4jの公式ドキュメントを参照のこと。
<!-- - ログレベルと用途は以下の通り。
    - DEBUG
    - INFO
    - WARN
    - ERROR
    - FATAL -->

### メッセージ管理

- v0.1では、サーバーサイドでの例外処理にのみ注目して記載する
- 定数クラスとプロパティファイルを利用したメッセージ管理の方式を説明する。

<!-- ### トランザクション管理 -->

### 入力値検査

- v0.1では、サーバーサイドでの例外処理にのみ注目して記載する
- 入力値検証は DomainModel と Controller の2箇所で実施する。それぞれの違いと実装方法は以下の通り。
    - DomainModel
        - 業務上のルールとして定義でき、アプリケーション内で一律で利用する制約を実装する。
            - 例：ユーザー名の文字数制限。メールアドレスや郵便番号の形式など。
        - 実装には Bean Validation を利用する。具体的な実装方法は [サーバーサイド機能詳細のアプリケーションコア層](server-side-function/application-core.md)を参照のこと。
    - Controller
        - 入力フォーム固有の制約を実装する。
            - 例：必須パラメータの存在チェック。任意パラメータが設定されていない場合のデフォルト値など。
        - 実装は Spring MVC のバリデーションを利用する。チェック項目が多い場合は、APIモデルに対して Bean Validation を利用する。

<!-- ### セキュリティ対策 -->
