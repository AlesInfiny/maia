# サーバーサイド機能解説 - プレゼンテーション層

プレゼンテーション層で実装するべき共通処理の詳細を示します。

## 入力チェック（単項目チェックと項目間チェック）

全体機能概要で説明した通り、プレゼンテーション層では入力値に対する単項目チェックと項目間チェックを実装します。

単項目チェックと項目間チェックは各 API の最初の処理として、入力値がシステムとして正しい値であるかどうかを確認します。

### 単項目チェック

単項目チェックは Bean Validation を利用して実装します。
チェックルールは API モデルに対して、ルールに対応するアノテーションを付与することで定義します。
実装方法については[こちら](https://docs.jboss.org/hibernate/stable/validator/reference/en-US/html_single/#chapter-bean-constraints)を参照してください。

Hibernate Validator で既に実装済みのチェックルールは[こちら](https://docs.jboss.org/hibernate/stable/validator/reference/en-US/html_single/#section-builtin-constraints)を参照してください。
単項目チェックのうち多くの場合は、これらの実装済みのチェックルールをそのまま利用するだけで要件を満たすチェックを行うことができます。
もしも、既存のチェックルールでは実現できないチェックルールがある場合には、[こちら](https://docs.jboss.org/hibernate/stable/validator/reference/en-US/html_single/#validator-customconstraints-simple)を参考にカスタムルールを独自で実装します。

入力チェック処理は、コントローラにおいて、引数である API モデルに対して一律入力チェックが実行されるように実装します。

### 項目間チェック

Hibernate Validator で定義済みのチェックルールは、単一項目に対するチェックルールであるため、複数の項目間のデータの整合性を確認する項目間チェックでは利用できません。
そのため、チェック処理は実装する必要があります。

チェック処理の実装は以下の2通りの方法が考えられます。

- コントローラの処理の中で実装する
  
- Bean Validation のカスタムルールとして実装する

全てをコントローラ内に実装してしまうと、同じようなチェックがある場合に、同じような実装が大量に実装されてしまうので、
汎用的なチェックルールについてはBean Validation のカスタムルールとして実装するのが望まれます。
項目間チェックの実装方法が2通りに分かれることを避けるために、項目間チェック全てをカスタムルールとして定義することも考えられますが、カスタムルールの実装は若干実装が煩雑になることを考慮して検討してください。

## 例外ハンドリング

業務例外については、業務フローに従って個別の例外ハンドリングが必用な場合には適切なレイヤでハンドリングを行います。
具体的にハンドリングを実装するレイヤやコンポーネントは業務フローに依ります。

プレゼンテーション層まででハンドリングされなかった業務例外やシステム例外については、集約例外ハンドラを実装し、一律にハンドリングされるようにします。

### 集約例外ハンドラの実装

集約例外ハンドラは Spring Framework の ControllerAdvice を利用して実装します。
ControllerAdvice はコントローラの共通処理を定義できるもので、
例外ハンドリングの実装もサポートしています。

集約例外ハンドラで実装すべき内容は以下の通りです。

- エラーログの出力

例外情報からエラーログメッセージを生成し、ログを出力します。
出力先や出力内容はログ出力方針に従います。

- エラーレスポンスの生成

API のエラーレスポンス設計に従い、レスポンスの HTTP ステータスコードの設定とレスポンスデータの生成を行います。
