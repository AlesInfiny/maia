# インフラストラクチャ層

インフラストラクチャ層の実装方針について説明します。

## データベースアクセス実装のフレームワーク　{: #database-access-framework }

Spring Boot を利用したアプリケーションにおいて、データベースアクセスを実装するためのフレームワークは大きく以下の3つが考えられます。
ここではそれぞれの特徴を説明します。

### MyBatis-Spring {: #mybats-spring }

MyBatis はストアドプロシージャや高度なマッピング処理を提供するORマッパーです。
他の OR マッパーと異なり、テーブルとオブジェクトをマッピングするのではなく、SQLの実行結果に対してオブジェクトをマッピングするという考えが特徴です。
複数のテーブルを結合するような場合、他の OR マッパーでは実装が煩雑になりがちである一方、 MyBatis では結合した結果に対するマッピングを同じように定義すれば良いため、多数のテーブルが関連し合うようなシステムに向いています。

全てのクエリについて、クエリとその実行結果とのマッピングを xml に定義する必用があるため、コード量は比較的大きくなりますが、
Spring Data でサポートされているような基本的な CRUD 処理については、[自動生成ツール](https://mybatis.org/generator/)で生成可能であるため、実際の開発量は他のORマッパーを利用した場合と大きくは変わりません。

MyBatis-Spring は MyBatis を Spring Framework 上で利用しやすいように、MyBatisのコンポーネントを DIコンテナで管理できるようにしたり、Spring の汎用的な例外への変換といった連携機能を提供しています。

### Spring Data JDBC {: #spring-data-jdbc }

JDBC でのデータベースアクセス実装をサポートするフレームワークです。
基本的な CRUD 処理の実装や Bean へのマッピング機能などが提供されるため、通常の JDBC による実装と比較して少量のコードで実装することができます。

Spring Data JDBC の詳細については[こちら](https://spring.pleiades.io/projects/spring-data-jpa)を参照してください。
https://spring.pleiades.io/projects/spring-data-jdbc

### Spring Data JPA {: #spring-data-jpa }

JPA（Java Persistence API）はデータベースのレコードとそれに対応するエンティティとの間のマッピングと、エンティティへの変更をデータベースへ反映させる仕組みを API 仕様として規定したものです。
そして Spring Data JPA は JPA の参照実装である Hibernate をベースにデータベースアクセスの実装をサポートするフレームワークです。
Spring Data JDBC と同じように基本的なCRUDの実装はフレームワークが提供してくれるため、シンプルなデータベースアクセスの場合は比較的少量のコードで実装できます。

ただし Spring Data JPA を採用する場合、開発者が JPA について正しく理解していないと、クエリの発行タイミングや実際に発行されるSQLが把握しにくくなるため注意が必要です。
またテーブル間の関連をエンティティに定義するため、あまり意識することなく関連テーブルのデータを結合して取得できる一方、テーブル結合の有無をクエリ単位で定義することが難しかったり、誤った実装をしてしまうと大量データの取得や大量のクエリ実行をしてしまうリスクもあります。
そのため開発者の JPA の開発経験や理解度がある程度保証できていることが望ましいです。

Spring Data JPA の詳細については[こちら](https://spring.pleiades.io/projects/spring-data-jpa)を参照してください。

### 各フレームワークの比較 {: #framework-comparison }

これまでの特徴から、データベースのテーブル構造やクエリがシンプルで、より軽量に実装を行いたい場合は Spring Data JDBC や Spring Data JPAを、
テーブルの関連が複雑で、結合を含む複雑なクエリが多く発生するような場合には MyBatis-Spring を採用することが望ましいです。
Maia OSS 版では、ある一定の規模であればテーブルの関連は複雑になりがちであることと、軽量なデータベースアクセス実装にも対応できることから、 MyBatis を利用した MyBatis-Spring を採用することを標準としています。

## MyBatis を用いたデータベースアクセス実装 {: #mybatis-implementation }
<!-- MyBatis を用いたデータベースアクセス についての解説。
- MyBatis Generator を用いた自動生成範囲と、個別実装範囲を明示する。
    - 単体テーブルアクセスは自動生成物で行い、テーブル結合を伴うテーブルアクセスは個別にRepositoryやMapperを実装する。
-->
MyBatis を利用した実装方針を説明します。

### MyBatis Generator による自動生成 {: #mybatis-genertor }

[MyBatis Generator](https://mybatis.org/generator/) はデータベースのテーブル構造を読み取り、テーブル単位の基本的な CRUD を実現するクエリとマッピングを自動で生成するツールです。
MyBatis Generator を利用することで、基本的な CRUD 処理は自動生成されたコードのみで実現できるようになります。
具体的な生成されるファイルは以下の通りです。

- 各テーブルに対応するテーブルエンティティクラス

- 基本的な CRUD に対応する SQL とその結果とエンティティとのマッピングが定義された xmlファイル

- 各クエリに対応する Java のインターフェース

### 自動生成以外のクエリの個別実装 {: #original-implementation }

テーブル結合を含む場合など、自動生成された基本的なクエリで実現できない場合には個別に実装が必要です。
上述の MyBatis Generator で自動生成されるファイルと同じファイルを、個別クエリに合わせて実装します。

### リポジトリの実装 {: #repository-implementation }

アプリケーションコア層のリポジトリインターフェースを実装するリポジトリクラスを実装します。
このクラスが実際に業務処理から呼び出されるリポジトリになります。
リポジトリでの主な実装内容は以下の通りです。

- テーブルエンティティとドメインモデルの変換

    アプリケーションコア層で定義されたリポジトリインターフェースの入出力はドメインモデルを中心とするデータになります。インフラストラクチャー層でのデータのやり取りはテーブル構造を元にしたテーブルエンティティで行うので、リポジトリで変換処理が必要になります。
    各変換処理は必要に応じて共通機能としてまとめて実装します。

- クエリに対応するJavaインターフェースを呼び出すことでクエリを実行
